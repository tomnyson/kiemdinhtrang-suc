<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Management - Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body.admin-body {
            background-color: #f4f6f9;
            padding: 20px;
        }

        .admin-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            border-bottom: 2px solid #005bac;
            margin-bottom: 20px;
            padding-bottom: 10px;
            color: #005bac;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* List View Styles */
        .controls-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-primary {
            background-color: #005bac;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-edit {
            background-color: #ffc107;
            color: #212529;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
        }

        /* Form View Styles */
        .form-view {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-cancel {
            background-color: #6c757d;
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .qr-thumb {
            width: 50px;
            height: 50px;
        }
    </style>
</head>

<body class="admin-body">

    <div class="admin-container">

        <!-- List View -->
        <div id="listView">
            <div class="admin-header">
                <h2>Product List</h2>
                <button class="btn-primary" onclick="showForm()">+ Add New</button>
            </div>

            <div class="controls-area">
                <input type="text" id="searchInput" class="search-box" placeholder="Search by ID..."
                    onkeyup="filterList()">
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Details</th>
                        <th>ID (实验号)</th>
                        <th>Image</th>
                        <th>Result (鉴定结果)</th>
                        <th>Mass</th>
                        <th>QR Link</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Items will be injected here -->
                </tbody>
            </table>
        </div>

        <!-- Form View -->
        <div id="formView" class="form-view">
            <div class="admin-header">
                <h2 id="formTitle">Add/Edit Certificate</h2>
            </div>

            <form id="certForm">
                <input type="hidden" id="editIndex" value="-1">

                <div class="form-group">
                    <label>Certificate ID (实验号)</label>
                    <input type="text" id="certId" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Total Mass (总质量)</label>
                    <input type="text" id="mass" class="form-control" value="50g">
                </div>

                <div class="form-group">
                    <label>Density (密度)</label>
                    <input type="text" id="density" class="form-control" value="3.33g/cm³">
                </div>

                <div class="form-group">
                    <label>Refractive Index (折射率)</label>
                    <input type="text" id="refraction" class="form-control" value="1.66 (点测)">
                </div>

                <div class="form-group">
                    <label>Optical Character (光性特征)</label>
                    <input type="text" id="optical" class="form-control" value="非均质集合体">
                </div>

                <div class="form-group">
                    <label>Absorption Spectrum (吸收光谱)</label>
                    <input type="text" id="spectrum" class="form-control" value="翡翠特征谱">
                </div>

                <div class="form-group">
                    <label>Magnification Test (放大检查)</label>
                    <input type="text" id="magnification" class="form-control" value="纤维柱粒交织结构">
                </div>

                <div class="form-group">
                    <label>Standard (检验依据)</label>
                    <input type="text" id="standard" class="form-control" value="GB/T 16552 GB/T 16553">
                </div>

                <div class="form-group">
                    <label>Remarks (备注)</label>
                    <input type="text" id="remarks" class="form-control" value="*****">
                </div>

                <div class="form-group">
                    <label>Result Title (鉴定结果)</label>
                    <input type="text" id="result" class="form-control" value="翡翠">
                </div>

                <div class="form-group">
                    <label>Image (Optional URL or leave for default)</label>
                    <input type="text" id="imageUrl" class="form-control" placeholder="Leave empty for default bangle">
                </div>

                <div style="margin-top: 20px;">
                    <button type="button" class="btn-cancel" onclick="showList()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Certificate</button>
                </div>
            </form>
        </div>

    </div>

    <script>
        let certList = [];

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderTable();
        });

        function loadData() {
            const stored = localStorage.getItem('certList');
            if (stored) {
                certList = JSON.parse(stored);
            } else {
                // Initialize with the default one if list is empty
                const oldSingle = localStorage.getItem('certData');
                if (oldSingle) {
                    certList.push(JSON.parse(oldSingle));
                } else {
                    // Seed data
                    certList.push({
                        certId: 'Z7281439',
                        mass: '50g',
                        density: '3.33g/cm³',
                        refraction: '1.66 (点测)',
                        optical: '非均质集合体',
                        spectrum: '翡翠特征谱',
                        magnification: '纤维柱粒交织结构',
                        standard: 'GB/T 16552 GB/T 16553',
                        remarks: '*****',
                        result: '翡翠'
                    });
                }
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('certList', JSON.stringify(certList));
        }

        // RENDER
        function renderTable(filterText = '') {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            certList.forEach((item, index) => {
                if (filterText && !item.certId.toLowerCase().includes(filterText.toLowerCase())) return;

                const tr = document.createElement('tr');

                // Get absolute URL for QR
                const link = `index.html?id=${encodeURIComponent(item.certId)}`;
                const absoluteLink = window.location.href.replace('admin.html', link);
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(absoluteLink)}`;

                // Image src logic
                const imgDisplay = (item.imageUrl && item.imageUrl.trim() !== '') ? item.imageUrl : 'bangle.png';

                tr.innerHTML = `
                    <td><a href="${link}" target="_blank">View Page</a></td>
                    <td><strong>${item.certId}</strong></td>
                    <td><img src="${imgDisplay}" class="qr-thumb" style="object-fit: cover; border: 1px solid #ddd;" /></td>
                    <td>${item.result}</td>
                    <td>${item.mass}</td>
                    <td><img src="${qrUrl}" class="qr-thumb" title="Link to ${item.certId}"/></td>
                    <td>
                        <button class="btn-edit" onclick="editItem(${index})">Edit</button>
                        <button class="btn-danger" onclick="deleteItem(${index})">Delete</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // ACTIONS
        function filterList() {
            const text = document.getElementById('searchInput').value;
            renderTable(text);
        }

        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this certificate?')) {
                certList.splice(index, 1);
                saveData();
                renderTable();
            }
        }

        function editItem(index) {
            const item = certList[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('formTitle').innerText = 'Edit Certificate';

            // Populate form
            document.getElementById('certId').value = item.certId || '';
            document.getElementById('mass').value = item.mass || '';
            document.getElementById('density').value = item.density || '';
            document.getElementById('refraction').value = item.refraction || '';
            document.getElementById('optical').value = item.optical || '';
            document.getElementById('spectrum').value = item.spectrum || '';
            document.getElementById('magnification').value = item.magnification || '';
            document.getElementById('standard').value = item.standard || '';
            document.getElementById('remarks').value = item.remarks || '';
            document.getElementById('result').value = item.result || '';
            document.getElementById('imageUrl').value = item.imageUrl || '';

            showForm();
        }

        function showForm() {
            document.getElementById('listView').style.display = 'none';
            document.getElementById('formView').style.display = 'block';

            // If adding new (editIndex is -1 reset by logic usually, but here reliant on caller)
            // Actually let's just create a helper for 'Add New'
            if (document.activeElement.innerText === '+ Add New') {
                document.getElementById('editIndex').value = '-1';
                document.getElementById('formTitle').innerText = 'New Certificate';
                document.getElementById('certForm').reset();
                // Set Defaults again because reset clears them
                document.getElementById('mass').value = '50g';
                // ... other defaults if needed, or just let them type
            }
        }

        function showList() {
            document.getElementById('listView').style.display = 'block';
            document.getElementById('formView').style.display = 'none';
        }

        // SAVE
        document.getElementById('certForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const idx = parseInt(document.getElementById('editIndex').value);
            const newItem = {
                certId: document.getElementById('certId').value,
                mass: document.getElementById('mass').value,
                density: document.getElementById('density').value,
                refraction: document.getElementById('refraction').value,
                optical: document.getElementById('optical').value,
                spectrum: document.getElementById('spectrum').value,
                magnification: document.getElementById('magnification').value,
                standard: document.getElementById('standard').value,
                remarks: document.getElementById('remarks').value,
                result: document.getElementById('result').value,
                imageUrl: document.getElementById('imageUrl').value
            };

            if (idx >= 0) {
                // Update
                certList[idx] = newItem;
            } else {
                // Add
                certList.push(newItem);
            }

            saveData();
            renderTable();
            showList();
        });

    </script>
</body>

</html>